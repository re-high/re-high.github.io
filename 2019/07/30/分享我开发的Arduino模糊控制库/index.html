<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>分享我开发的Arduino模糊控制库FuzzyControl | re-high的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="这是我开发的第一个库函数。使用这个库能够非常方便地构造一个双输入单输出模糊控制器，来实现模糊控制。希望能够给有需要的人带来帮助。 库下载地址： https://github.com/re-high/Arduino-FuzzyControl-Library  为什么要开发模糊控制库 模糊控制的优点：无模型控制在现代控制理论中，控制器的分析和综合大多依赖于精确的数学模型。由于被控对象过程的非线性、参数">
<meta property="og:type" content="article">
<meta property="og:title" content="分享我开发的Arduino模糊控制库FuzzyControl">
<meta property="og:url" content="https://re-high.github.io/2019/07/30/分享我开发的Arduino模糊控制库/index.html">
<meta property="og:site_name" content="re-high的博客">
<meta property="og:description" content="这是我开发的第一个库函数。使用这个库能够非常方便地构造一个双输入单输出模糊控制器，来实现模糊控制。希望能够给有需要的人带来帮助。 库下载地址： https://github.com/re-high/Arduino-FuzzyControl-Library  为什么要开发模糊控制库 模糊控制的优点：无模型控制在现代控制理论中，控制器的分析和综合大多依赖于精确的数学模型。由于被控对象过程的非线性、参数">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=3495053205,1412608988&fm=26&gp=0.jpg">
<meta property="og:image" content="https://s2.ax1x.com/2019/07/31/eNrO76.png">
<meta property="og:image" content="https://s2.ax1x.com/2019/07/31/eNsinI.png">
<meta property="og:image" content="https://s2.ax1x.com/2019/07/31/eNsFBt.png">
<meta property="og:image" content="https://s2.ax1x.com/2019/07/31/eNrhkT.png">
<meta property="og:image" content="https://s2.ax1x.com/2019/07/31/eNBXK1.jpg">
<meta property="og:image" content="https://s2.ax1x.com/2019/07/31/eNrW7V.jpg">
<meta property="og:updated_time" content="2019-07-31T13:34:07.763Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="分享我开发的Arduino模糊控制库FuzzyControl">
<meta name="twitter:description" content="这是我开发的第一个库函数。使用这个库能够非常方便地构造一个双输入单输出模糊控制器，来实现模糊控制。希望能够给有需要的人带来帮助。 库下载地址： https://github.com/re-high/Arduino-FuzzyControl-Library  为什么要开发模糊控制库 模糊控制的优点：无模型控制在现代控制理论中，控制器的分析和综合大多依赖于精确的数学模型。由于被控对象过程的非线性、参数">
<meta name="twitter:image" content="https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=3495053205,1412608988&fm=26&gp=0.jpg">
  
    <link rel="alternate" href="/atom.xml" title="re-high的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">re-high的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">分享科研探索过程中的问题和解决方案</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://re-high.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-分享我开发的Arduino模糊控制库" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/30/分享我开发的Arduino模糊控制库/" class="article-date">
  <time datetime="2019-07-30T10:41:31.000Z" itemprop="datePublished">2019-07-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      分享我开发的Arduino模糊控制库FuzzyControl
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这是我开发的第一个库函数。使用这个库能够非常方便地构造一个<strong>双输入单输出模糊控制器</strong>，来实现模糊控制。希望能够给有需要的人带来帮助。</p>
<p><strong>库下载地址</strong>： <a href="https://github.com/re-high/Arduino-FuzzyControl-Library" target="_blank" rel="noopener">https://github.com/re-high/Arduino-FuzzyControl-Library</a></p>
<hr>
<h3 id="为什么要开发模糊控制库"><a href="#为什么要开发模糊控制库" class="headerlink" title="为什么要开发模糊控制库"></a>为什么要开发模糊控制库</h3><ul>
<li>模糊控制的优点：无模型控制<br>在现代控制理论中，控制器的分析和综合大多依赖于精确的数学模型。由于被控对象过程的非线性、参数间的强耦合、过程机理复杂以及现场测量仪表条件不足，以致很多被控对象不能建立起数学模型，对于那些<strong>不能直接获得数学模型描述的系统</strong>，使用模糊控制往往能取得很好的效果。<br>人们在手动控制中，被控过程的操作人员在长期观察、实践中积累许多经验，这些经验常用定性的、不精确的语言规则等形式加以描述，如“若炉温偏高则燃料适当减少”。系统在运行过程中，人们将观察到的过程输出与设定值比较，得到过程输出偏离设定值变化快慢的模糊语义描述，经<strong>逻辑推理</strong>得到<strong>控制量的模糊量</strong>：“适当减少燃料”，经<strong>反模糊化</strong>后，转化为一<strong>精确的控制量</strong>，实现整个模糊过程。<img src="https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=3495053205,1412608988&fm=26&gp=0.jpg" width="70%">
以模糊集和模糊推理为基础，对上述手工操作过程进行建模，即可得到模糊控制器。</li>
<li>相对于另外一种无模型控制方法PID法，模糊控制算法更为复杂，要经过模糊化、模糊推理、解模糊，因此想在硬件中实现模糊控制算法代码量大很多。<br>在以往的项目中，我一般用<strong>面向过程</strong>的编程思想来写构造模糊控制器的代码，代码量随着隶属度函数和规则数的增加而增加，当想修改规则时，要改的地方非常多，造成<strong>代码可读性差且不易移植</strong>的困难。<br>所以我有了一个想法，用<strong>面向对象</strong>的编程思想开发一个Arduino的模糊控制库，把模糊化、模糊推理、解模糊这些步骤放在库文件里实现，用户只需要在主程序中调用相关函数添加变量的隶属度函数和添加控制规则，就能直接计算出输出量。这大大减少了用户用Arduino实现模糊控制时构造模糊控制器的时间，不需要自己编写模糊控制的过程。</li>
</ul>
<p>受到仿真软件matlab中<strong>模糊工具箱</strong>的启发，我编写了FuzzyControl库，让在硬件中实现模糊控制和在matlab中使用模糊工具箱函数搭建模糊控制器一样简单。</p>
<hr>
<h3 id="Arduino的模糊控制库FuzzyControl"><a href="#Arduino的模糊控制库FuzzyControl" class="headerlink" title="Arduino的模糊控制库FuzzyControl"></a>Arduino的模糊控制库FuzzyControl</h3><h4 id="FuzzyControl库简介"><a href="#FuzzyControl库简介" class="headerlink" title="FuzzyControl库简介"></a>FuzzyControl库简介</h4><p>FuzzyControl是我为了在Arduino中更方便地实现模糊控制而开发的Arduino库。不再需要用户自己编写模糊化、模糊推理、解模糊的过程，你只要添加变量的隶属度函数和控制规则就能直接计算出输出量。当你想实现电机转速控制、双轮自平衡车的角度控制时，都可以用FuzzyControl库轻松方便地构建一个双输入单输出模糊控制器。<br>下面，我将首先介绍FuzzyControl库函数，然后以Arduino Uno配合带编码器的直流电机，演示如何使用FuzzyControl库构造一个模糊控制器，实现<strong>电机的位置追踪控制</strong>。</p>
<h4 id="FuzzyControl库函数"><a href="#FuzzyControl库函数" class="headerlink" title="FuzzyControl库函数"></a>FuzzyControl库函数</h4><p><strong>setRange</strong><br> 功能：设置输入输出变量的论域<br> 格式：setRange(input1rangeMin, input1rangeMax,input2rangeMin, input2rangeMax, outputrangeMin, outputrangeMax)<br> 说明：setRange函数有6个输入变量：</p>
<ul>
<li>input1rangeMin：输入量1的论域最小值</li>
<li>input1rangeMax：输入量1的论域最大值</li>
<li>input2rangeMin：输入量2的论域最小值</li>
<li>input2rangeMax：输入量2的论域最大值</li>
<li>outputrangeMin：输出量的论域最小值</li>
<li>outputrangeMax：输出量的论域最大值</li>
</ul>
<p><strong>addmf</strong><br> 功能：添加隶属度函数<br> 格式：addmf( varType, mfIndex, trimf_a, trimf_b, trimf_c); addmf( varType, mfIndex, trapmf_a, trapmf_b, trapmf_c, trapmf_d);<br> 说明：addmf函数有5或6个输入变量（根据隶属度函数是三角型还是梯形决定）：</p>
<ul>
<li>varType：要添加隶属度函数的变量类型（1表示input1，2表示input2，3表示input3）</li>
<li>mfIndex：模糊子集索引（模糊子集名称）</li>
<li>trimf_a、trimf_b、trimf_c是三角型隶属度函数的参数</li>
<li>trapmf_a、trapmf_b、trapmf_c、trapmf_d是梯型隶属度函数的参数</li>
</ul>
<p><strong>setrulenum</strong><br> 功能：输入控制规则总数目<br> 格式：setrulenum(ruleNum);<br> 说明：setrulenum函数有1个输入变量：</p>
<ul>
<li>ruleNum：控制规则总数目</li>
</ul>
<p><strong>addrule</strong><br> 功能：增加控制规则<br> 格式：addrule(ruleIndex, var1Index, var2Index, var3Index)<br> 说明：addrule函数有4个输入变量：</p>
<ul>
<li>ruleIndex：要添加的控制规则是第几条规则</li>
<li>var1Index：这条控制规则中的input1所属的模糊子集索引</li>
<li>var2Index：这条控制规则中的input2所属的模糊子集索引</li>
<li>var3Index：这条控制规则中的output所属的模糊子集索引</li>
</ul>
<p><strong>caculate</strong><br> 功能：完成模糊推理计算<br> 格式：caculate( value1, value2);<br> 说明：caculate函数有2个输入变量：</p>
<ul>
<li>value1：输入量1的数值</li>
<li>value2：输入量2的数值</li>
</ul>
<hr>
<h3 id="实例：使用FuzzyControl库实现电机的位置追踪控制"><a href="#实例：使用FuzzyControl库实现电机的位置追踪控制" class="headerlink" title="实例：使用FuzzyControl库实现电机的位置追踪控制"></a>实例：使用FuzzyControl库实现电机的位置追踪控制</h3><p>介绍完FuzzyControl库函数，下面就用来看一下怎么用FuzzyControl库构造一个两输入单输出模糊控制器，来控制直流电机追踪到理想的位置。本程序设置电机的理想位置信号设置为y=50sin(0.1pi * t )，即20s产生一个完整的正弦波，控制目标就是让电机的位置追踪这个理想正弦信号。</p>
<h4 id="电路连接图"><a href="#电路连接图" class="headerlink" title="电路连接图"></a>电路连接图</h4><p>用到的硬件包括：Arduino Uno（控制器）、带编码器的直流电机、电机驱动模块TB6612FNG、电源。<br>注意：由于未找到编码器的素材，所以图中少画了编码器与Arduino的连接图。为了得到位置信号，应将编码器A相连接Arduino数字引脚2（中断0）、B相连接Arduino数字引脚3（中断1）。<br><img src="https://s2.ax1x.com/2019/07/31/eNrO76.png" width="70%"></p>
<h4 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h4><p> 总体方案：选用两输入单输出模糊控制器，控制器输入为追踪误差（e）和误差变化率（ec），输出为PWM值。</p>
<ol>
<li>定义覆盖输入、输出变量的模糊子集 <ul>
<li>确定输入输出变量的论域：输入为追踪误差（e）和误差变化率（ec），初步设置输入范围为[-20，20]；输出为PWM值，输出变化范围为[-255，255]。</li>
<li>确定模糊集个数及各模糊集的隶属度函数：将追踪误差（e）和误差变化率（ec）都分为3个模糊集：N（负）Z（零）P(正)；将输出的PWM值分为5个模糊集：NB（负大）NS（负小）ZZ（零）PS（正小）PB（正大）。</li>
<li>输入隶属度函数选取为三角形+梯形隶属函数，输出隶属度函数选取为三角形隶属函数。</li>
<li>模糊集参数的选取：对于输入追踪误差（e）和误差变化率（ec），初步选取模糊集参数如下：<br>NumMFs（模糊子集个数）=3<br>MF1=’N’:’trapmf’,[-20 -20 -5 0]；<br>MF2=’Z’:’trimf’,[-3 0 3]；<br>MF3=’P’:’trapmf’,[0 5 20 20]<img src="https://s2.ax1x.com/2019/07/31/eNsinI.png" width="70%">
对于输出PWM值，初步选取模糊集参数如下：NumMFs（模糊子集个数）=5
MF1='NB':'trimf',[-255 -180 -100]；
MF2='NS':'trimf',[-200 -110 -20]；
MF3='ZZ':'trimf',[-75 0 75]；
MF4='PS':'trimf',[20 110 200]；
MF5='PB':'trimf',[100 180 255]
<img src="https://s2.ax1x.com/2019/07/31/eNsFBt.png" width="70%">

</li>
</ul>
</li>
</ol>
<p>利用库函数设置输入输出模糊子集程序代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"> //setRange函数设置输入输出论域，输入范围为[-20，20]，输出范围为[-255，255]</span><br><span class="line">   fuzzyController.setRange(-20,20,-20,20,-255,255);   </span><br><span class="line">   /*addmf函数添加隶属度函数</span><br><span class="line">    * 第一个参数表示变量类型（1表示input1，2表示input2，3表示input3）</span><br><span class="line">    * 第二个参数表示模糊子集索引（模糊子集名称）</span><br><span class="line">    * 后面的参数是三角型或梯形隶属度函数的参数    */</span><br><span class="line">   fuzzyController.addmf(1,N,-20,-20,-5,0);</span><br><span class="line">   fuzzyController.addmf(1,Z,-3,0,3);</span><br><span class="line">   fuzzyController.addmf(1,P,0,5,20,20);</span><br><span class="line">   fuzzyController.addmf(2,N,-20,-20,-5,0);</span><br><span class="line">   fuzzyController.addmf(2,Z,-3,0,3);</span><br><span class="line">   fuzzyController.addmf(2,P,0,5,20,20);</span><br><span class="line">   fuzzyController.addmf(3,NB,-255,-180,-100);</span><br><span class="line">   fuzzyController.addmf(3,NS,-200,-110,-20);</span><br><span class="line">   fuzzyController.addmf(3,ZZ,-75,0,75);</span><br><span class="line">   fuzzyController.addmf(3,PS,20,110,200);</span><br><span class="line">   fuzzyController.addmf(3,PB,100,180,255);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>设计并建立模糊控制规则：<br>模糊规则就是输入量和输出量间的<strong>模糊蕴含</strong>关系。确定PWM值大小的核心思想为“当追踪误差增大时增大PWM值”，建立9条模糊控制规则：<ul>
<li>if追踪误差是 N and 误差变化率是 N ，then PWM值是 NB；</li>
<li>if追踪误差是 N and 误差变化率是 Z ，then PWM值是 NS；</li>
<li>if追踪误差是 N and 误差变化率是 P ，then PWM值是 ZZ；</li>
<li>if追踪误差是 Z and 误差变化率是 N ，then PWM值是 NS；</li>
<li>if追踪误差是 Z and 误差变化率是 Z ，then PWM值是 ZZ；</li>
<li>if追踪误差是 Z and 误差变化率是 P ，then PWM值是 PS；</li>
<li>if追踪误差是 P and 误差变化率是 N ，then PWM值是 ZZ；</li>
<li>if追踪误差是 P and 误差变化率是 Z ，then PWM值是 PS；</li>
<li>if追踪误差是 P and 误差变化率是 P ，then PWM值是 PB；</li>
</ul>
</li>
</ol>
<p>在这里解释一下我这里的规则是如何建立的，比如第一条，追踪误差是N，表明追踪误差小于0，误差变化率是N，表明误差变化率也小于0，误差还在继续减小，这说明追踪误差的绝对值是在增大的，那输出的PWM值绝对值也是应该增大的，至于方向，是和连接电路时电机的转动方向有关，我在这里用实物测试出此时应该反转，所以PWM值为负，所以设置输出PWM值是 NB。再看第七条，追踪误差是P，表明追踪误差大于0，误差变化率是N，表明误差变化率小于0，两者结合在一起说明追踪误差虽然大于0但是误差量是在减少的，这个趋势是我们想要看到的所以设置输出 PWM值是 ZZ。其他规则同理。<br>在这里想告诉大家，规则的设定在构造模糊控制器中占有很重要的地位，一定要根据实际情况来设置模糊规则，判断逻辑推理的正确性。<br>利用库函数<strong>添加模糊规则程序</strong>代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//setrulenum函数设置模糊控制规则总数</span><br><span class="line">fuzzyController.setrulenum(9); </span><br><span class="line">//依次添加控制规则，第一次输入参数表示当前输入的是第几条规则</span><br><span class="line">//后面三个参数分别为input1、input2、output所属的模糊子集索引（模糊子集名称）</span><br><span class="line">fuzzyController.addrule(1,N,N,NB);  </span><br><span class="line">fuzzyController.addrule(2,N,Z,NS); </span><br><span class="line">fuzzyController.addrule(3,N,P,ZZ); </span><br><span class="line">fuzzyController.addrule(4,Z,N,NS); </span><br><span class="line">fuzzyController.addrule(5,Z,Z,ZZ); </span><br><span class="line">fuzzyController.addrule(6,Z,P,PS); </span><br><span class="line">fuzzyController.addrule(7,P,N,ZZ); </span><br><span class="line">fuzzyController.addrule(8,P,Z,PS);</span><br><span class="line">fuzzyController.addrule(9,P,P,PB);</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>完整程序代码<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">  Arduino通过FuzzyControl库构造一个双输入单输出的模糊控制器，控制直流电机追踪到理想的位置（本程序中理想位置设置的为正弦信号）</span><br><span class="line">  by 梁悦（https://re-high.github.io/）</span><br><span class="line"> </span><br><span class="line">  如需获得本示例程序详细电路信息以及如何使用FuzzyControl库的更多知识，请参考我的博客：</span><br><span class="line">   https://re-high.github.io/</span><br><span class="line"> </span><br><span class="line">*/</span><br><span class="line">#include &lt;FuzzyControl.h&gt;</span><br><span class="line">//初始化一个双输入单输出的模糊控制器</span><br><span class="line">//三个输入参数分别是输入量1、输入量2、输出量的模糊子集个数</span><br><span class="line">FuzzyControl fuzzyController(3,3,5);</span><br><span class="line">int fuzhi = 50;              //fuzhi：正弦波的幅值</span><br><span class="line">#define ENCODER_A_PIN 2      //直流电机编码器的A相连接引脚</span><br><span class="line">#define ENCODER_B_PIN 3      //直流电机编码器的B相连接引脚</span><br><span class="line">#define motor1 8             //电机</span><br><span class="line">#define motor2 9             //电机</span><br><span class="line">#define ENA 5                //使能引脚</span><br><span class="line">#define STBY 12</span><br><span class="line">//定义模糊子集名称及其对应的索引</span><br><span class="line">#define N 1</span><br><span class="line">#define Z 2</span><br><span class="line">#define P 3</span><br><span class="line">#define NB 1</span><br><span class="line">#define NS 2</span><br><span class="line">#define ZZ 3</span><br><span class="line">#define PS 4</span><br><span class="line">#define PB 5</span><br><span class="line">long position;               //编码器每获取一个脉冲，position+1</span><br><span class="line">double position_actual;      //当前位置</span><br><span class="line">double error_last = 0;              </span><br><span class="line">long   preTime=0;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">void setup() &#123;</span><br><span class="line">  // put your setup code here, to run once:</span><br><span class="line">   Serial.begin(2000000);</span><br><span class="line">   //setRange函数设置输入输出论域，输入范围为[-20，20]，输出范围为[-255，255]</span><br><span class="line">   fuzzyController.setRange(-20,20,-20,20,-255,255);   </span><br><span class="line">   /*addmf函数添加隶属度函数</span><br><span class="line">    * 第一个参数表示变量类型（1表示input1，2表示input2，3表示input3）</span><br><span class="line">    * 第二个参数表示模糊子集索引（模糊子集名称）</span><br><span class="line">    * 后面的参数是三角型或梯形隶属度函数的参数    */</span><br><span class="line">   fuzzyController.addmf(1,N,-20,-20,-5,0);</span><br><span class="line">   fuzzyController.addmf(1,Z,-3,0,3);</span><br><span class="line">   fuzzyController.addmf(1,P,0,5,20,20);</span><br><span class="line">   fuzzyController.addmf(2,N,-20,-20,-5,0);</span><br><span class="line">   fuzzyController.addmf(2,Z,-3,0,3);</span><br><span class="line">   fuzzyController.addmf(2,P,0,5,20,20);</span><br><span class="line">   fuzzyController.addmf(3,NB,-255,-180,-100);</span><br><span class="line">   fuzzyController.addmf(3,NS,-200,-110,-20);</span><br><span class="line">   fuzzyController.addmf(3,ZZ,-75,0,75);</span><br><span class="line">   fuzzyController.addmf(3,PS,20,110,200);</span><br><span class="line">   fuzzyController.addmf(3,PB,100,180,255);</span><br><span class="line">   //setrulenum函数设置模糊控制规则总数</span><br><span class="line">   fuzzyController.setrulenum(9); </span><br><span class="line">   //依次添加控制规则，第一次输入参数表示当前输入的是第几条规则</span><br><span class="line">   //后面三个参数分别为input1、input2、output所属的模糊子集索引（模糊子集名称）</span><br><span class="line">   fuzzyController.addrule(1,N,N,NB);  </span><br><span class="line">   fuzzyController.addrule(2,N,Z,NS); </span><br><span class="line">   fuzzyController.addrule(3,N,P,ZZ); </span><br><span class="line">   fuzzyController.addrule(4,Z,N,NS); </span><br><span class="line">   fuzzyController.addrule(5,Z,Z,ZZ); </span><br><span class="line">   fuzzyController.addrule(6,Z,P,PS); </span><br><span class="line">   fuzzyController.addrule(7,P,N,ZZ); </span><br><span class="line">   fuzzyController.addrule(8,P,Z,PS);</span><br><span class="line">   fuzzyController.addrule(9,P,P,PB); </span><br><span class="line">  pinMode(motor1, OUTPUT);                          //电机引脚设置</span><br><span class="line">  pinMode(motor2, OUTPUT); </span><br><span class="line">  pinMode(ENA,OUTPUT);</span><br><span class="line">  pinMode(STBY,OUTPUT);</span><br><span class="line">  digitalWrite(STBY, HIGH);   </span><br><span class="line">  pinMode(ENCODER_A_PIN, INPUT);</span><br><span class="line">  pinMode(ENCODER_B_PIN, INPUT);</span><br><span class="line">  attachInterrupt(0, read_quadrature, CHANGE);           //设置外部中断</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void loop() &#123;</span><br><span class="line">unsigned long now = millis();   //获取当前时间</span><br><span class="line">float position_ideal=fuzhi*sin(0.1*3.14*now/1000);  //产生正弦波</span><br><span class="line">float TimeCh = (now-preTime)/1000.0;  </span><br><span class="line">float SampleTime = 0.05;       //设置采样时间</span><br><span class="line">if (TimeCh&gt;=SampleTime)</span><br><span class="line">&#123;</span><br><span class="line"> position_actual =(double) position/130;    //标准化当前位置，和编码器的线数有关，这里的position_actual单位是圈数</span><br><span class="line"> double error = position_actual - position_ideal;        //计算当前时刻的追踪偏差</span><br><span class="line"> double  DTerm = (error-error_last)/TimeCh;               //计算偏差变化率</span><br><span class="line"> error = constrain(error,-20,20);  //避免输入量1超过设置的论域，对输入量1进行限幅</span><br><span class="line"> DTerm = constrain(DTerm,-20,20);  //避免输入量2超过设置的论域，对输入量2进行限幅</span><br><span class="line">int  u = (int)fuzzyController.caculate(error,DTerm);  // 计算模糊控制器的输出量</span><br><span class="line">u = constrain(u,-255,255);  //对输出量限幅</span><br><span class="line">dianji(u);    //把计算得到的控制量传给电机转动函数</span><br><span class="line">error_last = error;   //把当前控制周期的追踪偏差赋值给error_last，给下个控制周期计算用</span><br><span class="line">preTime = now;        //把当前控制周期的时刻值赋值给preTime，给下个控制周期计算用</span><br><span class="line">serialprint(position_ideal,position_actual);  //串口监控函数</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">/**************************************************************************</span><br><span class="line">函数功能：外部中断读取编码器数据</span><br><span class="line">**************************************************************************/</span><br><span class="line">void read_quadrature()&#123;  </span><br><span class="line">  // found a low-to-high on channel A ENA脚下降沿中断触发</span><br><span class="line">  if (digitalRead(ENCODER_A_PIN) == LOW)&#123;   </span><br><span class="line">    // check channel B to see which way 查询ENB的电平以确认是顺时针还是逆时针旋转</span><br><span class="line">    if (digitalRead(ENCODER_B_PIN) == LOW)</span><br><span class="line">      position++;</span><br><span class="line">  &#125;</span><br><span class="line">  // found a high-to-low on channel A ENA脚上升沿中断触发</span><br><span class="line">  else&#123;</span><br><span class="line">    // check channel B to see which way 查询ENB的电平以确认是顺时针还是逆时针旋转</span><br><span class="line">    if (digitalRead(ENCODER_B_PIN) == LOW)</span><br><span class="line">      position--;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; </span><br><span class="line">/**************************************************************************</span><br><span class="line">函数功能：电机转动</span><br><span class="line">入口参数：控制量u</span><br><span class="line">**************************************************************************/</span><br><span class="line">void dianji(int u)&#123;</span><br><span class="line">  if(u&lt;0)&#123;</span><br><span class="line">    digitalWrite(motor1, HIGH);  //设置电机转动方向</span><br><span class="line">    digitalWrite(motor2, LOW);  </span><br><span class="line">    analogWrite(ENA,abs(u));     //把PWM绝对值传入使能引脚，让电机转动</span><br><span class="line">  &#125;</span><br><span class="line">  else&#123;</span><br><span class="line">     digitalWrite(motor1, LOW);  </span><br><span class="line">     digitalWrite(motor2, HIGH);  </span><br><span class="line">     analogWrite(ENA,abs(u));  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">/**************************************************************************</span><br><span class="line">函数功能：串口输出当前时刻理想的位置信号和当前位置</span><br><span class="line">**************************************************************************/</span><br><span class="line">void serialprint(float position_ideal,double position_actual)&#123;</span><br><span class="line">Serial.print(position_ideal); </span><br><span class="line">Serial.print(&quot; &quot;); </span><br><span class="line">Serial.println(position_actual);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="实验结果"><a href="#实验结果" class="headerlink" title="实验结果"></a>实验结果</h4><p>打开Arduino IDE自带的串口绘图器，可以看到跟踪结果如下图所示，<strong>蓝色</strong>线为<strong>理想的位置信号</strong>，<strong>红色</strong>线为<strong>电机的实际位置</strong>。模糊控制的效果还是很不错的！<br>控制器性能的好坏取决于变量的模糊子集设定和建立的控制规则，想进一步提高控制效果可以通过<strong>定义更多的模糊子集</strong>、<strong>增加控制规则</strong>、<strong>修改隶属度函数参数</strong>等方式实现。<br><img src="https://s2.ax1x.com/2019/07/31/eNrhkT.png" width="70%"><br>从串口输出的数据可以导出到matlab中进行进一步分析，透过数据可以分析这个控制器目前的问题，来设计<strong>更优的控制器</strong>。本程序中我设置的隶属度函数参数就是反复实验后确定的，下图是优化控制器参数前后的跟踪结果的对比图。可以看到，优化参数前的模糊控制器也是在追踪目标信号的，但是追踪误差很大，在根据实际情况优化隶属度函数参数后，追踪误差明显减小。<br><img src="https://s2.ax1x.com/2019/07/31/eNBXK1.jpg" width="50%"><br><img src="https://s2.ax1x.com/2019/07/31/eNrW7V.jpg" width="50%"></p>
<hr>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>从实验可以看出，使用本FuzzyControl库构造一个双输入单输出的模糊控制器是非常方便的，和在matlab中使用模糊工具箱搭建模糊控制器的过程很像，不论是给变量添加隶属度函数还是增减规则，库函数都可以直接实现。<br>目前的FuzzyControl库还有一些问题存在，比如说只支持三角形和梯形隶属度函数以及由于采用COG解模糊法所以输出变量的隶属度函数最好设置为等腰三角型。如果之后有时间，我会再更新FuzzyControl库，让它变得更完善。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://re-high.github.io/2019/07/30/分享我开发的Arduino模糊控制库/" data-id="cjyrank84000170wc5em2clil" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2019/07/24/控制算法，从仿真到实现/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">控制算法，从仿真到实现</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/07/30/分享我开发的Arduino模糊控制库/">分享我开发的Arduino模糊控制库FuzzyControl</a>
          </li>
        
          <li>
            <a href="/2019/07/24/控制算法，从仿真到实现/">控制算法，从仿真到实现</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 梁悦<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>